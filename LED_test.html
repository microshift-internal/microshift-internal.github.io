<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED 行為模擬</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #1a237e;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 800px;
            margin: 20px auto;
        }
        .led-details {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: box-shadow 0.2s;
        }
        .led-details[open] {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .led-summary {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            list-style: none; /* Hide default marker */
        }
        .led-summary::-webkit-details-marker {
            display: none; /* Hide default marker for Chrome/Safari */
        }
        .led-summary::before {
            content: '►';
            margin-right: 10px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        .led-details[open] > .led-summary::before {
            transform: rotate(90deg);
        }
        .led-content {
            padding: 0px 20px 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .led-description {
             flex-grow: 1;
        }
        .led-description p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }
        .led-light {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #222; /* Off state */
            border: 3px solid #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.2) inset;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            margin-left: 20px;
        }
        .led-light::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 12px;
            width: 15px;
            height: 8px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 10px / 5px;
            transform: rotate(45deg);
        }
        .play-button {
            padding: 8px 16px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 15px;
            transition: background-color 0.2s;
        }
        .play-button:hover {
            background-color: #0056b3;
        }
        .play-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* --- Animations --- */
        @keyframes blink-500-1500 {
            0%, 25% { opacity: 1; } /* On for 500ms */
            25.1%, 100% { opacity: 0; } /* Off for 1500ms */
        }
        @keyframes blink-300-300-300-300 {
            0%, 25% { opacity: 1; } /* On 300ms */
            25.1%, 50% { opacity: 0; } /* Off 300ms */
            50.1%, 75% { opacity: 1; } /* On 300ms */
            75.1%, 100% { opacity: 0; } /* Off 300ms */
        }
         @keyframes blink-100-100-x4 {
            0%, 6.25% { opacity: 1; }
            6.26%, 12.5% { opacity: 0; }
            12.51%, 18.75% { opacity: 1; }
            18.76%, 25% { opacity: 0; }
            25.01%, 31.25% { opacity: 1; }
            31.26%, 37.5% { opacity: 0; }
            37.51%, 43.75% { opacity: 1; }
            43.76%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>

    <h1>LED 行為模擬</h1>

    <div class="container" id="led-container">
        <!-- LED cards will be dynamically inserted here -->
    </div>

    <script>
        const ledData = `
配對模式\t藍\t是\t亮500ms滅1500ms
配對完成\t藍\t否\t亮300ms滅300ms亮300ms滅300ms
配對失敗\t藍+紅\t否\t藍亮200ms滅200ms紅亮200ms滅200ms藍亮200ms滅200ms紅亮200ms滅200ms
進入調整模式\t綠\t是\t恆亮
調整觸發指令\t綠\t否\t滅500ms恆亮
調整歸零\t綠\t否\t滅300ms亮300ms滅300ms亮300ms
離開調整模式\t綠\t否\t滅
後變電源電壓過低1\t紅\t否\t亮300ms滅300ms亮300ms滅300ms
後變電源電壓過低2\t紅\t否\t亮100ms滅100ms亮100ms滅100ms亮100ms滅100ms亮100ms滅100ms
錯誤/運作異常\t紫(紅+藍)\t否\t亮300ms滅300ms亮300ms滅300ms
更新模式\t白(紅+綠+藍)\t是\t亮500ms滅1500ms
BLE模式\t青(綠+藍)\t是\t亮500ms滅1500ms
        `;

        const colorMap = {
            '藍': '#007bff',
            '紅': '#dc3545',
            '綠': '#28a745',
            '藍+紅': '#800080', // Purple
            '紫(紅+藍)': '#800080', // Purple
            '白(紅+綠+藍)': '#ffffff',
            '青(綠+藍)': '#00ffff'  // Cyan
        };

        const container = document.getElementById('led-container');

        ledData.trim().split('\n').forEach((line, index) => {
            const [name, colorStr, loop, pattern] = line.split('\t');
            const isLoop = loop === '是';
            
            const details = document.createElement('details');
            details.className = 'led-details';
            
            const summary = document.createElement('summary');
            summary.className = 'led-summary';
            summary.textContent = name;
            
            const content = document.createElement('div');
            content.className = 'led-content';

            const description = document.createElement('div');
            description.className = 'led-description';
            description.innerHTML = `<p>${pattern}</p>`;
            
            const light = document.createElement('div');
            light.className = 'led-light';
            light.id = `led-${index}`;
            
            content.appendChild(description);
            
            if (!isLoop) {
                const button = document.createElement('button');
                button.className = 'play-button';
                button.textContent = '播放一次';
                button.addEventListener('click', () => {
                    applyLedBehavior(light, colorStr, pattern, false, button);
                });
                content.appendChild(button);
            }

            content.appendChild(light);
            details.appendChild(summary);
            details.appendChild(content);
            container.appendChild(details);
            
            if (isLoop) {
                details.addEventListener('toggle', (event) => {
                    if (details.open) {
                        applyLedBehavior(light, colorStr, pattern, true);
                    } else {
                        // Stop animation when closing
                        light.style.animation = 'none';
                        if (light.intervalId) {
                            clearInterval(light.intervalId);
                            light.intervalId = null;
                        }
                    }
                });
            }

             // Pre-open the first one for demonstration
            if (index === 0) {
                details.open = true;
            }
        });

        function applyLedBehavior(element, colorStr, pattern, isLoop, button = null) {
            if (button) {
                button.disabled = true;
            }

            // Reset any previous animations
            element.style.animation = 'none';
            element.style.opacity = '1';
            element.style.backgroundColor = '#222';
            if (element.intervalId) {
                clearInterval(element.intervalId);
                element.intervalId = null;
            }
             if (element.timeoutIds) {
                element.timeoutIds.forEach(clearTimeout);
                element.timeoutIds = [];
            }


            const baseColor = colorMap[colorStr] || '#222';
            const iteration = isLoop ? 'infinite' : '1';
            const fillMode = isLoop ? '' : 'forwards';

            const animationEndHandler = () => {
                if (!isLoop) {
                    element.style.animation = '';
                    if(button) button.disabled = false;
                }
                element.removeEventListener('animationend', animationEndHandler);
            };
            element.addEventListener('animationend', animationEndHandler);

            if (pattern.includes('恆亮')) {
                const delay = pattern.startsWith('滅') ? parseInt(pattern.match(/\d+/)[0]) : 0;
                element.timeoutIds = [];
                const id = setTimeout(() => {
                    element.style.backgroundColor = baseColor;
                    element.style.opacity = 1;
                    if(button) button.disabled = false;
                }, delay);
                element.timeoutIds.push(id);
                
            } else if (pattern.includes('滅') && !pattern.includes('亮')) { // 滅
                 element.style.backgroundColor = '#222';
                 element.style.opacity = 0;
                 if(button) button.disabled = false;

            } else if (pattern === '亮500ms滅1500ms') {
                element.style.backgroundColor = baseColor;
                element.style.animation = `blink-500-1500 2s ${iteration} ${fillMode}`;
            } else if (pattern === '亮300ms滅300ms亮300ms滅300ms') {
                element.style.backgroundColor = baseColor;
                element.style.animation = `blink-300-300-300-300 1.2s ${iteration} ${fillMode}`;
            } else if (pattern === '亮100ms滅100ms亮100ms滅100ms亮100ms滅100ms亮100ms滅100ms') {
                 element.style.backgroundColor = baseColor;
                 element.style.animation = `blink-100-100-x4 1.6s ${iteration} ${fillMode}`;
            } else if (pattern === '滅300ms亮300ms滅300ms亮300ms') { 
                element.style.backgroundColor = baseColor;
                element.style.animation = `blink-300-300-300-300 1.2s ${iteration} reverse ${fillMode}`;
            } else if (pattern.includes('藍亮') && pattern.includes('紅亮')) { // 配對失敗
                element.style.transition = 'background-color 0.1s ease';
                let state = 0;
                
                if (isLoop) {
                    element.intervalId = setInterval(() => {
                        runSequence(element, state);
                        state = (state + 1) % 8;
                    }, 200);
                } else {
                    element.timeoutIds = [];
                    const runOnce = (step) => {
                        if (step >= 8) {
                            element.style.backgroundColor = '#222'; // End in off state
                            if (button) button.disabled = false;
                            return;
                        }
                        runSequence(element, step);
                        const id = setTimeout(() => runOnce(step + 1), 200);
                        element.timeoutIds.push(id);
                    };
                    runOnce(0);
                }
            }
        }

        function runSequence(element, step) {
             switch(step % 8) {
                case 0: element.style.backgroundColor = colorMap['藍']; break;
                case 1: element.style.backgroundColor = '#222'; break;
                case 2: element.style.backgroundColor = colorMap['紅']; break;
                case 3: element.style.backgroundColor = '#222'; break;
                case 4: element.style.backgroundColor = colorMap['藍']; break;
                case 5: element.style.backgroundColor = '#222'; break;
                case 6: element.style.backgroundColor = colorMap['紅']; break;
                case 7: element.style.backgroundColor = '#222'; break;
            }
        }
    </script>
</body>
</html>
